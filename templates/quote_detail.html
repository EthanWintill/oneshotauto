{% extends "base.html" %}

{% block title %}Quote {{ quote.quote_number }} - Body Work Quote Tracker{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('quote_detail', id=quote.id) }}" class="bg-white rounded-lg shadow">
    {{ form.hidden_tag() }}

    <!-- Top Section: Base Information Header -->
    <div class="bg-gradient-to-br from-gray-50 to-white px-8 py-6 border-b-2 border-gray-200">
        <h3 class="text-base font-bold text-primary-dark mb-4 pb-2 border-b border-gray-300">Base Information</h3>

        <div class="grid grid-cols-2 gap-x-8 gap-y-6 mb-10">
            <!-- Quote Number -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.quote_number.label.text }}</label>
                {{ form.quote_number(class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent") }}
            </div>

            <!-- Date -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.date.label.text }}</label>
                {{ form.date(class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent") }}
            </div>

            <!-- VIN Number -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.vin_number.label.text }}</label>
                {{ form.vin_number(class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent") }}
            </div>

            <!-- VIN Picture -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.vin_picture_link.label.text }}</label>
                <input type="file" accept="image/*" class="picture-input block w-full text-sm text-gray-600 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-primary-blue file:to-blue-600 file:text-white hover:file:from-primary-blue-hover hover:file:to-blue-700 file:cursor-pointer file:transition-all file:shadow-sm">
                {{ form.vin_picture_link(class="picture-url hidden") }}
                <img class="picture-preview max-w-[150px] max-h-[150px] mt-3 rounded-md border-2 border-gray-200 {% if quote.vin_picture_link %}block{% else %}hidden{% endif %}" src="{{ quote.vin_picture_link if quote.vin_picture_link else '' }}">
            </div>

            <!-- Year -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.year.label.text }}</label>
                {{ form.year(class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent") }}
            </div>

            <!-- Make -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.make.label.text }}</label>
                {{ form.make(class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent") }}
            </div>

            <!-- Model -->
            <div class="col-span-2">
                <label class="block text-sm font-semibold text-gray-700 mb-2">{{ form.model.label.text }}</label>
                {{ form.model(class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent") }}
            </div>
        </div>
    </div>

    <!-- Instructions Box (1/5 of page) -->
    <div class="px-8 py-6 bg-gradient-to-br from-blue-50 to-gray-50 border-b-2 border-gray-300">
        <label for="{{ form.instructions.id }}" class="block mb-3 text-sm font-bold text-primary-dark uppercase tracking-wide">{{ form.instructions.label.text }}</label>
        {{ form.instructions(class="w-full p-4 bg-white border-2 border-gray-200 rounded-lg text-sm resize-none leading-relaxed text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent", rows="6", placeholder="Enter specific instructions for this body work quote (optional)...") }}
        {% if form.instructions.errors %}
            <span class="block text-danger text-sm mt-1">{{ form.instructions.errors[0] }}</span>
        {% endif %}
    </div>

    <!-- Services Table (Remaining ~4/5 of page) -->
    <div>
        <table class="w-full">
            <thead>
                <tr class="bg-gradient-to-r from-primary-dark to-primary-dark-hover text-white">
                    <th class="py-4 px-6 text-left text-sm font-semibold uppercase tracking-wider sticky top-0 z-10 bg-gradient-to-r from-primary-dark to-primary-dark-hover w-36 shadow-sm">Service</th>
                    <th class="py-4 px-6 text-left text-sm font-semibold uppercase tracking-wider sticky top-0 z-10 bg-gradient-to-r from-primary-dark to-primary-dark-hover w-64 shadow-sm">Photo</th>
                    <th class="py-4 px-6 text-left text-sm font-semibold uppercase tracking-wider sticky top-0 z-10 bg-gradient-to-r from-primary-dark to-primary-dark-hover w-36 shadow-sm">Parts ($)</th>
                    <th class="py-4 px-6 text-left text-sm font-semibold uppercase tracking-wider sticky top-0 z-10 bg-gradient-to-r from-primary-dark to-primary-dark-hover w-36 shadow-sm">Labor ($)</th>
                    <th class="py-4 px-6 text-right text-sm font-semibold uppercase tracking-wider sticky top-0 z-10 bg-gradient-to-r from-primary-dark to-primary-dark-hover w-36 shadow-sm">Total</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for service_key, service_name in services %}
                {% set photo_field = form|get_field(service_key + '_photo_link') %}
                {% set parts_field = form|get_field(service_key + '_parts_cost') %}
                {% set labor_field = form|get_field(service_key + '_labor_cost') %}
                <tr class="hover:bg-blue-50/50 transition-colors duration-150">
                    <td class="py-5 px-6 align-middle">
                        <span class="font-semibold text-gray-900 text-base">{{ service_name }}</span>
                    </td>
                    <td class="py-5 px-6">
                        <div class="space-y-3">
                            <input type="file" accept="image/*" class="picture-input block w-full text-sm text-gray-600 file:mr-4 file:py-2.5 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-primary-blue file:to-blue-600 file:text-white hover:file:from-primary-blue-hover hover:file:to-blue-700 file:cursor-pointer file:transition-all file:shadow-sm">
                            {{ photo_field(class="picture-url hidden") }}
                            <img class="picture-preview max-w-[140px] max-h-[140px] rounded-lg border-2 border-gray-200 shadow-sm {% if quote|get_field(service_key + '_photo_link') %}block{% else %}hidden{% endif %}" src="{{ quote|get_field(service_key + '_photo_link') or '' }}">
                        </div>
                    </td>
                    <td class="py-5 px-6">
                        {{ parts_field(class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent transition-shadow parts-cost", step="0.01", placeholder="0.00", oninput="calculateServiceTotal(this)") }}
                    </td>
                    <td class="py-5 px-6">
                        {{ labor_field(class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent transition-shadow labor-cost", step="0.01", placeholder="0.00", oninput="calculateServiceTotal(this)") }}
                    </td>
                    <td class="py-5 px-6 text-right">
                        <span class="service-total font-bold text-lg text-primary-dark" data-service="{{ service_key }}">${{ "%.2f"|format(quote.get_service_total(service_key)) }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Bottom Section: Grand TOTAL -->
    <div class="flex items-center justify-between px-8 py-6 bg-gradient-to-r from-gray-50 to-gray-100 border-t-4 border-primary-dark shadow-inner">
        <div class="flex items-baseline gap-3">
            <span class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Grand Total:</span>
            <span class="text-3xl font-bold text-primary-dark" id="grand-total">${{ "%.2f"|format(quote.get_grand_total()) }}</span>
        </div>
        <div class="flex items-center gap-4">
            <a href="{{ url_for('index') }}" class="inline-flex items-center justify-center px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg no-underline transition-all duration-200 border border-gray-300 shadow-sm hover:shadow">
                Cancel
            </a>

            {% if is_xero_connected() %}
                <button type="button" onclick="sendToXero()" class="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Send to Xero
                </button>
            {% else %}
                <a href="{{ url_for('xero_authorize') }}" class="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                    Connect to Xero First
                </a>
            {% endif %}

            {{ form.submit(class="inline-flex items-center justify-center px-8 py-3 bg-gradient-to-r from-primary-blue to-blue-600 hover:from-primary-blue-hover hover:to-blue-700 text-white font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg cursor-pointer") }}
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    function calculateServiceTotal(input) {
        const row = input.closest('tr');
        const partsInput = row.querySelector('.parts-cost');
        const laborInput = row.querySelector('.labor-cost');
        const totalCell = row.querySelector('.service-total');

        const parts = parseFloat(partsInput.value) || 0;
        const labor = parseFloat(laborInput.value) || 0;
        const total = parts + labor;

        totalCell.textContent = '$' + total.toFixed(2);

        // Update grand total
        updateGrandTotal();
    }

    function updateGrandTotal() {
        const serviceTotals = document.querySelectorAll('.service-total');
        let grandTotal = 0;

        serviceTotals.forEach(cell => {
            const text = cell.textContent.replace('$', '');
            grandTotal += parseFloat(text) || 0;
        });

        document.getElementById('grand-total').textContent = '$' + grandTotal.toFixed(2);
    }

    // Send quote to Xero
    function sendToXero() {
        // Create a hidden form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('send_quote_to_xero_route', id=quote.id) }}";
        document.body.appendChild(form);
        form.submit();
    }

    // Initialize calculations on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Trigger calculation for all inputs to ensure totals are correct
        const allInputs = document.querySelectorAll('.parts-cost, .labor-cost');
        allInputs.forEach(input => {
            // Set initial values if they're empty but have data
            if (!input.value && input.dataset.value) {
                input.value = input.dataset.value;
            }
        });
        updateGrandTotal();
    });
</script>
{% endblock %}
